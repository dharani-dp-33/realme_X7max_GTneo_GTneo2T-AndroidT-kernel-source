name: Realme X7 Max Stable Builder
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Sources
        run: |
          git clone --depth=1 \
            "https://github.com/dharani-dp-33/realme_X7max_GTneo_GTneo2T-AndroidT-kernel-source" \
            realme-kernel
          
          git clone --depth=1 \
            "https://github.com/mt6893-development/android_kernel_oplus_mt6893" \
            oneplus-kernel

      - name: Verify Paths
        run: |
          # Check Realme DTS existence
          if [ ! -d "realme-kernel/arch/arm64/boot/dts/oplus" ]; then
            echo "::error::Realme DTS not found at expected path!"
            exit 1
          fi

          # Check touchscreen driver
          if [ ! -f "realme-kernel/drivers/input/touchscreen/oplus_touchscreen/realme_ts.c" ]; then
            echo "::error::Touchscreen driver missing!"
            exit 1
          fi

      - name: Merge Components
        run: |
          # Create directory structure
          mkdir -p oneplus-kernel/arch/arm64/boot/dts/oplus
          mkdir -p oneplus-kernel/drivers/input/touchscreen/oplus_touchscreen

          # Copy Realme-specific components
          cp -r realme-kernel/arch/arm64/boot/dts/oplus/* oneplus-kernel/arch/arm64/boot/dts/oplus/
          cp realme-kernel/drivers/input/touchscreen/oplus_touchscreen/realme_ts.c oneplus-kernel/drivers/input/touchscreen/oplus_touchscreen/

          # Clean OnePlus problematic code
          rm -rf oneplus-kernel/block/uxio_first
          sed -i '/uxio_first/d' oneplus-kernel/block/Kconfig

      - name: Build
        run: |
          cd oneplus-kernel
          make ARCH=arm64 realme_x7max_defconfig
          make -j$(nproc) ARCH=arm64

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: realme-op-merged
          path: oneplus-kernel/arch/arm64/boot/Image
