name: Realme X7 Max Stock Kernel Builder
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: dharani-dp-33/realme_X7max_GTneo_GTneo2T-AndroidT-kernel-source
        ref: master

    - name: Clean Configuration
      run: |
        # Remove ALL problematic Kconfig references
        sed -i '/rootguard/d' arch/arm64/Kconfig
        sed -i '/sched_assist/d' init/Kconfig
        sed -i '/klockopt/d' init/Kconfig
        
        # Force disable missing components
        echo '# CONFIG_ROOTGUARD is not set' >> arch/arm64/configs/k6891v1_64_k419_defconfig
        echo '# CONFIG_SCHED_ASSIST is not set' >> arch/arm64/configs/k6891v1_64_k419_defconfig
        echo '# CONFIG_KLOCKOPT is not set' >> arch/arm64/configs/k6891v1_64_k419_defconfig
        
        # Enable essential module features
        sed -i 's/CONFIG_MODULE_SIG=y//' arch/arm64/configs/k6891v1_64_k419_defconfig
        echo 'CONFIG_MODULES=y' >> arch/arm64/configs/k6891v1_64_k419_defconfig
        echo 'CONFIG_MODULE_FORCE_LOAD=y' >> arch/arm64/configs/k6891v1_64_k419_defconfig

    - name: Build Kernel
      run: |
        export ARCH=arm64
        make O=out k6891v1_64_k419_defconfig
        make -j$(nproc) O=out
        
    - name: Verify Build
      run: |
        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "Build successful!"
          ls -lh out/arch/arm64/boot/Image.gz-dtb
        else
          echo "Build failed - check logs"
          exit 1
        fi

    - name: Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: x7max-stock-kernel
        path: out/arch/arm64/boot/Image.gz-dtb
