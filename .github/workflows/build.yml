name: Realme X7 Max Kernel Builder
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ========================
      # 1. Checkout Kernel Source
      # ========================
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: dharani-dp-33/realme_X7max_GTneo_GTneo2T-AndroidT-kernel-source
          ref: master
          path: kernel

      # ========================
      # 2. Nuclear Fix: Remove OPLUS Dependencies
      # ========================
      - name: Purge OPLUS Configs
        run: |
          cd kernel
          # Find defconfig
          DEFCONFIG=$(find arch/arm64/configs -name "*_defconfig" -print -quit)
          
          # Delete ALL OPLUS-related configurations
          sed -i '/OPLUS_/d' $DEFCONFIG
          sed -i '/_FEATURE_/d' $DEFCONFIG
          sed -i '/sched_assist/d' $DEFCONFIG

          # Verify changes
          echo "Modified defconfig:"
          cat $DEFCONFIG

      # ========================
      # 3. Build Setup
      # ========================
      - name: Prepare Build Environment
        run: |
          cd kernel
          make ARCH=arm64 defconfig
          make ARCH=arm64 prepare

      # ========================
      # 4. Build Kernel (Generic)
      # ========================
      - name: Build Generic Kernel
        run: |
          cd kernel
          export ARCH=arm64
          set -ex
          make clean && make mrproper
          make defconfig
          make -j$(nproc) 2>&1 | tee build.log

      # ========================
      # 5. Upload Artifacts
      # ========================
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: kernel/arch/arm64/boot/Image*
