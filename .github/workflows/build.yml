name: Realme X7 Max Kernel Builder
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Fetch all code
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: dharani-dp-33/realme_X7max_GTneo_GTneo2T-AndroidT-kernel-source
          ref: master

      - name: Checkout MemKernel
        uses: actions/checkout@v4
        with:
          repository: dharani-dp-33/MemKernel
          path: MemKernel

      # 2. Setup environment
      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libncurses-dev bison flex libssl-dev

      # 3. Auto-detect defconfig (priority: device name -> chipset -> first found)
      - name: Find Defconfig
        id: find-defconfig
        run: |
          cd MemKernel
          DEFCONFIG=$(find arch/arm64/configs/ -name "*x7max*defconfig" || 
                     find arch/arm64/configs/ -name "*mt6893*defconfig" || 
                     find arch/arm64/configs/ -name "*_defconfig" | head -n1)
          
          if [ -z "$DEFCONFIG" ]; then
            echo "::error::DEFCONFIG NOT FOUND! Check your kernel source."
            exit 1
          fi
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
          echo "Using: $DEFCONFIG"

      # 4. Modern toolchain (adjust URL if needed)
      - name: Setup Toolchain
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_clang_host_linux-x86_clang-r487747 toolchain

      # 5. Simplified build process
      - name: Build Kernel
        run: |
          cd MemKernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_PATH=$(pwd)/../toolchain/bin/clang
          
          # Clean build
          make clean && make mrproper
          
          # Build
          make $DEFCONFIG
          make -j$(nproc) CC=clang

      # 6. Smart artifact upload
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build
          path: |
            MemKernel/arch/arm64/boot/Image*
            MemKernel/out/arch/arm64/boot/Image*
