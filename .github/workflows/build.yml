name: Realme X7 Max Kernel Builder  
on:  
  workflow_dispatch:  
  push:  
    branches: [master]  

jobs:  
  build:  
    runs-on: ubuntu-latest  
    steps:  
      # ========================  
      # 1. Fresh Clone & Nuclear Cleanup  
      # ========================  
      - name: Clone and Purge OPLUS  
        run: |  
          git clone --depth=1 \  
            https://github.com/dharani-dp-33/realme_X7max_GTneo_GTneo2T-AndroidT-kernel-source \  
            kernel  
          cd kernel  

          # Delete ALL OPLUS directories  
          rm -rf \  
            arch/arm64/kernel/rootguard \  
            kernel/sched_assist \  
            kernel/locking/klockopt \  
            drivers/soc/oplus \  
            drivers/input/touchscreen/oplus_touchscreen  

          # Purge OPLUS references from all files  
          find . -type f \( -name "*Kconfig*" -o -name "*Makefile*" -o -name "*.mk" \) \  
            -exec sed -i \  
              -e '/OPLUS_/d' \  
              -e '/_FEATURE_/d' \  
              -e '/rootguard/d' \  
              -e '/sched_assist/d' \  
              -e '/klockopt/d' \  
              -e '/oplus_touchscreen/d' \  
              {} \;  

      # ========================  
      # 2. Build with Isolated Config  
      # ========================  
      - name: Build Vanilla Kernel  
        run: |  
          cd kernel  
          export ARCH=arm64  

          # Minimal defconfig (no dependencies)  
          cat << EOF > arch/arm64/configs/generic_defconfig  
          CONFIG_ARM64=y  
          CONFIG_SMP=y  
          CONFIG_BLOCK=y  
          CONFIG_MMU=y  
          EOF  

          # Clean environment  
          make O=build distclean  

          # Build  
          make O=build generic_defconfig  
          make O=build -j$(nproc)  

      # ========================  
      # 3. Validate & Upload  
      # ========================  
      - name: Upload Artifact  
        uses: actions/upload-artifact@v4  
        with:  
          name: kernel-build  
          path: kernel/build/arch/arm64/boot/Image*  
          if-no-files-found: error  
